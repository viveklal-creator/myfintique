<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fintique - MoM TB Comparison</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/fintique_logo_white_text.png') }}">
  <style>
    body {
      font-size: 12px;
    }
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    .navbar-theme.dark-mode {
      background: linear-gradient(to right, #4b0082, #8b0000);
    }
    .btn-theme.dark-mode {
      background: linear-gradient(to right, #8b0000, #4b0082);
      color: white;
      border: none;
    }
    .table-container {
      overflow: auto;
      max-height: 80vh;
      border: 1px solid #dee2e6;
      position: relative;
    }
    table {
      border-collapse: collapse;
      min-width: 100%;
    }
    th, td {
      border: 1px solid #dee2e6;
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
      background-color: #fff;
      color: #000;
    }
    body.dark-mode th,
    body.dark-mode td {
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f1f3f5;
    }
    body.dark-mode thead th {
      background-color: #2a2a2a;
    }
    .sticky-type {
      position: sticky;
      left: 0;
      min-width: 100px;
      z-index: 20;
      background-color: #f8f9fa;
    }
    .sticky-gl {
      position: sticky;
      left: 100px;
      min-width: 150px;
      z-index: 20;
      background-color: #f8f9fa;
    }
    body.dark-mode .sticky-type,
    body.dark-mode .sticky-gl {
      background-color: #2c2c2c;
    }
    th.sticky-type,
    th.sticky-gl {
      z-index: 30 !important;
    }
    td.remarks, td.manager-remarks,
    th.remarks, th.manager-remarks {
      min-width: 200px;
      max-width: 250px;
      white-space: normal;
      vertical-align: top;
    }
    textarea {
      width: 100%;
      border: none;
      resize: vertical;
      font-size: 12px;
      padding: 4px;
      background-color: inherit;
      color: inherit;
    }
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .logo {
      height: 150px;
      width: 200px;
      object-fit: contain;
    }
    .navbar {
      height: 60px;
    }
    .navbar-brand {
      display: flex;
      align-items: center;
      padding: 0;
    }
    .gl-link {
      color: #0d6efd;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body id="body">
  <nav class="navbar navbar-expand-lg navbar-theme py-0" id="navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('dashboard') }}">
        <img src="{{ url_for('static', filename='images/fintique_logo_white_text.png') }}" alt="Fintique Logo" class="logo">
      </a>
      <div class="ms-auto d-flex align-items-center gap-3">
        <button class="btn btn-sm btn-outline-light" onclick="toggleDarkMode()">üåô Toggle Dark Mode</button>
        <a class="btn btn-outline-light" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <h4>Month-on-Month Trial Balance Comparison</h4>
    <div class="action-bar">
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">‚Üê Back to Dashboard</a>
      <a href="/export_mom_tb_excel" class="btn btn-success btn-sm">Export to Excel</a>
    </div>
    <div class="mt-3 text-end">
      <button class="btn btn-primary btn-sm" onclick="saveRemarks()">Save Remarks</button>
    </div>
    <div class="table-container">
      <table id="tbTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const userRole = '{{ session.get("role") }}';

    function applyDarkMode(state) {
      const ids = ['body', 'navbar'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('dark-mode', state);
      });
      if (state) document.body.classList.add('dark-mode');
      else document.body.classList.remove('dark-mode');
    }

    function toggleDarkMode() {
      const isDark = document.getElementById('body').classList.toggle('dark-mode');
      applyDarkMode(isDark);
      localStorage.setItem('zentro-dark-mode', isDark ? 'on' : 'off');
    }

    window.onload = function () {
      const mode = localStorage.getItem('zentro-dark-mode');
      if (mode === 'on') {
        applyDarkMode(true);
      }
    };

    fetch("/api/mom_tb_comparison")
      .then(async res => {
        if (!res.ok) {
          throw new Error(`Failed to fetch data: ${res.status}`);
        }
        return res.json();
      .then(data => {
        const head = document.getElementById("tableHead");
        const body = document.getElementById("tableBody");
        
        if (!data.months || !data.rows) {
          body.innerHTML = `<tr><td colspan="100%">No data available</td></tr>`;
          return;
        })

        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `
          <th class="sticky-type">Type</th>
          <th class="sticky-gl">GL</th>
          ${data.months.map(m => `<th>${m}</th>`).join('')}
          <th>Variance</th>
          <th>Variance %</th>
          <th class="remarks">Remarks</th>
          <th class="manager-remarks">Manager Remarks</th>
        `;
        head.appendChild(headerRow);

        fetch("/api/get_remarks")
          .then(r => r.json())
          .then(savedRemarks => {
            const latestMonth = data.months[data.months.length - 1];
            const remarksForMonth = savedRemarks[latestMonth] || {};

            data.rows.forEach(row => {
              const gl = row.gl;
              const remarkObj = remarksForMonth[gl] || {};
              const disableUserField = userRole === 'manager';
              const disableManagerField = userRole !== 'manager';

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class="sticky-type">${row.type}</td>
                <td class="sticky-gl"><a class="gl-link" target="_blank" href="/gl_details?gl=${encodeURIComponent(row.gl)}">${row.gl}</a></td>
                ${data.months.map(m => `<td>${row.months[m] || '-'}</td>`).join('')}
                <td>${row.variance}</td>
                <td>${row.variance_pct}</td>
                <td class="remarks"><textarea rows="2" ${disableUserField ? 'readonly title="You need permission to change this field"' : ''}>${remarkObj.remark || ""}</textarea></td>
                <td class="manager-remarks"><textarea rows="2" ${disableManagerField ? 'readonly title="You need permission to change this field"' : ''}>${remarkObj.manager_remark || ""}</textarea></td>
              `;
              body.appendChild(tr);
            });
          });
      });
      .catch(err => {
        console.error("API error:", err);
        const body = document.getElementById("tableBody");
        body.innerHTML = `<tr><td colspan="100%" style="color:red;">Error loading data. Please try again later.</td></tr>`;
      });

    function saveRemarks() {
      const headers = Array.from(document.querySelectorAll("#tableHead th"));
      const months = headers.slice(2, headers.length - 4).map(h => h.textContent.trim());
      const latestMonth = months[months.length - 1];

      const rows = Array.from(document.querySelectorAll("#tableBody tr"));
      const remarksData = {};

      rows.forEach(row => {
        const gl = row.querySelector(".sticky-gl")?.textContent.trim();
        if (gl) {
          if (!remarksData[gl]) remarksData[gl] = {};
          if (userRole === 'admin') {
            remarksData[gl]["remark"] = row.querySelector("td.remarks textarea")?.value.trim() || "";
          }
          if (userRole === 'manager') {
            remarksData[gl]["manager_remark"] = row.querySelector("td.manager-remarks textarea")?.value.trim() || "";
          }
        }
      });

      const payload = {
        month: latestMonth,
        remarks: remarksData
      };

      fetch("/api/save_remarks", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          alert("Remarks saved successfully.");
        } else {
          alert("Failed to save remarks: " + (data.message || ''));
        }
      })
      .catch(err => {
        console.error("Error saving remarks:", err);
        alert("Error while saving remarks.");
      });
    }
  </script>
</body>
</html>